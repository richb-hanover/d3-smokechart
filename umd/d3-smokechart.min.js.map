{"version":3,"file":"d3-smokechart.min.js","sources":["../dist/index.js"],"sourcesContent":["import { scaleLinear } from \"d3-scale\";\nimport { line } from \"d3-shape\";\nconst quantile = (probes, q) => {\n    if (q < 0 || q > 1 || isNaN(q))\n        throw new Error(`Unable to calculate ${q} quantile`);\n    var alq = (probes.length - 1) * q;\n    var idx = Math.floor(alq);\n    var diff = alq - idx;\n    return diff < 0.001 ? probes[idx] : Math.floor(probes[idx] * (1 - diff) + probes[idx + 1] * diff + 0.5);\n};\nconst smokeAreaConfig = [\n    [],\n    [[0, 1]],\n    [[0, 1], [.25, .75]],\n    [[0, 1], [.15, .85], [.3, .7]],\n    [[0, 1], [.1, .9], [.2, .8], [.3, .7]],\n    [[0, 1], [.1, .9], [.2, .8], [.3, .7], [.4, .6]]\n];\nexport const calculateSmokeBands = (v, bands) => {\n    const bandKind = Array.isArray(bands) ? bands : smokeAreaConfig[bands];\n    return bandKind.map(([from, to]) => [quantile(v, from), quantile(v, to)]);\n};\nconst flameAreaConfig = [\n    [],\n    [.5],\n    [.5, .75],\n    [.5, .7, .9],\n    [.4, .55, .7, .85],\n    [.5, .6, .7, .8, .9]\n];\nexport const Smokechart = (smokeData, opts) => {\n    const props = {\n        scaleX: scaleLinear(),\n        scaleY: scaleLinear(),\n    };\n    let data = [];\n    let errs = [];\n    let classSuffix = Math.floor(Math.random() * 100000);\n    const smoke = (smokeData, opts) => {\n        if (smokeData && !Array.isArray(smokeData)) {\n            opts = smokeData;\n            smokeData = undefined;\n        }\n        if (opts)\n            Object.assign(props, opts);\n        if (smokeData)\n            smoke.data(smokeData);\n        classSuffix = Math.floor(Math.random() * 100000);\n        return smoke;\n    };\n    smoke.data = (smokeData) => {\n        if (smokeData) {\n            data = smokeData.map(arr => [...arr.filter(n => !isNaN(n))].sort((a, b) => a - b));\n            errs = smokeData.map(arr => {\n                return {\n                    errors: [...arr.filter(n => isNaN(n))].length,\n                    count: arr.length,\n                };\n            });\n            return smoke;\n        }\n        return data;\n    };\n    smoke.adjustScaleRange = () => {\n        if (props.scaleX)\n            props.scaleX.domain([0, data.length]);\n        if (!props.scaleY)\n            return;\n        let minY = Infinity;\n        let maxY = -Infinity;\n        data.forEach(arr => {\n            if (arr.length) {\n                if (arr[0] < minY)\n                    minY = arr[0];\n                if (arr[arr.length - 1] > maxY)\n                    maxY = arr[arr.length - 1];\n            }\n        });\n        props.scaleY.domain([minY, maxY]);\n        return smoke;\n    };\n    smoke.scaleX = (newScale) => {\n        if (newScale) {\n            props.scaleX = newScale;\n            return smoke;\n        }\n        return props.scaleX;\n    };\n    smoke.scaleY = (newScale) => {\n        if (newScale) {\n            props.scaleY = newScale;\n            return smoke;\n        }\n        return props.scaleY;\n    };\n    smoke.line = (q = 0.5) => {\n        const l = line()\n            .x(d => props.scaleX(d[0]))\n            .y(d => props.scaleY(d[1]));\n        const quantileData = data.reduce((reslt, values, idx) => {\n            const p = quantile(values, q);\n            return [...reslt, [idx - 0.5, p], [idx + 0.5, p]];\n        }, []);\n        return [l(quantileData)];\n    };\n    smoke.smokeBands = (bCount = 2) => {\n        const l = line()\n            .x(d => props.scaleX(d[0]))\n            .y(d => props.scaleY(d[1]));\n        const bands = data.reduce((reslt, values, idx) => {\n            const bandData = calculateSmokeBands(values, bCount);\n            const x = idx - 0.5;\n            const bandLines = bandData.map(([y0, y1]) => l([\n                [x, y0],\n                [x, y1],\n                [x + 1, y1],\n                [x + 1, y0],\n            ]) || \"\");\n            return [...reslt, bandLines];\n        }, []);\n        return bands[0].map((_, columnIdx) => bands.map(row => row[columnIdx]).join(\"\"));\n    };\n    smoke.countErrors = () => {\n        return errs.reduce((reslt, { errors, count }, xPos) => {\n            return errors > 0 && count > 0 ? [...reslt, { errors, count, xPos }] : reslt;\n        }, []);\n    };\n    smoke.chart = (selection, args) => {\n        if (args === null || args === void 0 ? void 0 : args.bands) {\n            selection\n                .selectAll(\"path.smokechart-band\" + classSuffix)\n                .data(smoke.smokeBands(args === null || args === void 0 ? void 0 : args.bands))\n                .enter()\n                .append(\"path\")\n                .classed(\"smokechart-band\", true)\n                .attr(\"fill\", (args === null || args === void 0 ? void 0 : args.bandsColor) || \"rgba(0,0,0,0.18)\")\n                .attr(\"d\", (d) => d);\n        }\n        selection\n            .selectAll(\"path.smokechart-line\" + classSuffix)\n            .data(smoke.line(0.5))\n            .enter()\n            .append(\"path\")\n            .classed(\"smokechart-line\", true)\n            .attr(\"shape-rendering\", \"crispEdges\")\n            .attr(\"stroke\", (args === null || args === void 0 ? void 0 : args.lineColor) || \"#ff0000\")\n            .attr(\"stroke-width\", (args === null || args === void 0 ? void 0 : args.lineWidth) || 2)\n            .attr(\"fill\", \"transparent\")\n            .attr(\"d\", (d) => d);\n        const eRadius = (args === null || args === void 0 ? void 0 : args.errorRadius) || 0;\n        if (eRadius > 0) {\n            const paths = smoke.countErrors().map(({ errors, count, xPos }) => {\n                if (errors > 0 && count > 0) {\n                    const startX = props.scaleX(xPos);\n                    const startY = 1;\n                    const alpha = (Math.PI * 2 * errors) / count;\n                    const endX = eRadius * Math.sin(alpha) + startX;\n                    const endY = eRadius * Math.cos(alpha + Math.PI) + startY + eRadius;\n                    return `M ${startX},${startY + eRadius} v-${eRadius} A ${eRadius},${eRadius} 0,0,1 ${endX},${endY} Z`;\n                }\n            });\n            selection\n                .selectAll(\"path.smokechart-errs\")\n                .data([paths.join(\" \")])\n                .enter()\n                .append(\"path\")\n                .attr(\"fill\", \"#f30\")\n                .attr(\"d\", (d) => d);\n        }\n    };\n    return smoke(smokeData, opts);\n};\n"],"names":["quantile","probes","q","isNaN","Error","alq","length","idx","Math","floor","diff","smokeAreaConfig","calculateSmokeBands","v","bands","Array","isArray","map","from","to","smokeData","opts","props","scaleX","scaleLinear","scaleY","data","errs","classSuffix","random","smoke","undefined","Object","assign","arr","filter","n","sort","a","b","errors","count","adjustScaleRange","domain","minY","Infinity","maxY","forEach","newScale","line","x","d","y","l","reduce","reslt","values","p","smokeBands","bCount","bandData","y0","y1","_","columnIdx","row","join","countErrors","xPos","chart","selection","args","selectAll","enter","append","classed","attr","bandsColor","lineColor","lineWidth","eRadius","errorRadius","paths","startX","startY","alpha","PI","endX","sin","endY","cos"],"mappings":"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"}